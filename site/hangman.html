<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Hangman</title>
    <link rel="stylesheet" type="text/css" href="css/hangman.css" />
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
    <!--[if IE]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body onload="">
     <div id="gallows">
        <div class="top"></div >
        <div class="support"></div>
        <div class="hanger"></div >
        <div class="upright"></div>
        <div class="bottom"></div>
          <div id="figure" class="stick">
            <div id="head" class="head"></div>
            <div id="body" class="body"></div>
            <div id="lefth" class="lefthand part"><div></div></div>
            <div id="righth" class="righthand part"><div></div></div>
            <div id="leftf" class="leftfoot part"><div></div></div>
            <div id="rightf" class="rightfoot part"><div></div></div>
        </div>
      </div>
    <div class="usrint">
        <p id="hint"></p>
        <p id="abstract"></p>
        <p>Guess a letter</p>
        <input id="letter" maxlength="1" size="1" />
        <button id="myButton">Submit</button>
        <button id="newGame">New Game</button>
	<button id="finalGuess">Final Guess</button>
    </div>
  </body>
    <script>
        var MYGAME = {
            killStages: ["", "head", "body", "lefth", "righth", "leftf", "rightf"],
            hint:       '',
            curr:       [],
            missed:     [],
            game:       0, 
            auth:       '',
            execute:      function() {
                try {
                    if (this.missed.length > 0) {
                        document.getElementById(this.killStages[this.missed.length]).style.display = "block";
                    }
                } catch(err) {
                    newGame();
                }
            },
            reset:      function() {
                var sk = this.killStages.slice(1, this.killStages.length)
                for (i in sk) {
                    document.getElementById(sk[i]).style.display = "none";
                }
            }
        }

        document.getElementById("myButton").onclick = function() {
            guess = document.getElementById("letter").value;
            game = {Cmd: "P1T", Play: guess, Gid: MYGAME.game, Auth: MYGAME.auth};
            console.log("Sending: " + JSON.stringify(game));
            wsocket.send(JSON.stringify(game));
        };

        document.getElementById("finalGuess").onclick = function() {
            var answer;
            do {
                answer = prompt("Final guess: ");
            } while(answer.length < 1);
            game = {Cmd: "FIN", Play: answer, Gid: MYGAME.game, Auth: MYGAME.auth};
            console.log("Sending: " + JSON.stringify(game));
            wsocket.send(JSON.stringify(game));
        };

        $("#letter").keyup(function(event){
            if(event.keyCode == 13){
                $("#myButton").click();
            }
        });

        if ("WebSocket" in window) {
            var wsocket = new WebSocket("ws://richmond.cookgetsitdone.com/wshangman");
            wsocket.onopen = function() {
                newGame();
            };
            wsocket.onmessage = function (event) { 
                var msg = JSON.parse(event.data);
                console.log("Received: " + event.data);
                switch (msg.Cmd) {
                    case "NEW":
                        MYGAME.hint = msg.Hint;
                        MYGAME.auth = msg.Cred; 
                        MYGAME.game = msg.Game;
                        document.getElementById("hint").innerHTML = MYGAME.hint;
                        break;
                }
                MYGAME.curr = function() { 
                    var tmp = [];
                    for (i in msg.Curr) {
                        tmp[i] = String.fromCharCode(msg.Curr[i])
                    }
                    return tmp;
                }();
                MYGAME.missed = msg.Missed;
                document.getElementById("abstract").innerHTML = function() {
                    var tmp = [];
                    for (i in MYGAME.curr) {
                        if (MYGAME.curr[i] === "\00") {
                            tmp[i] = '\u2610';
                        } else {
                            tmp[i] = MYGAME.curr[i];
                        }
                    }
                    return tmp;
                }().join(' ');
                $("#abstract").effect("shake");
                $("#letter").val('');
                MYGAME.execute();
            };
            wsocket.onclose = function() { 
                console.log("Connection is closed..."); 
            };
        } else {
            var wsocket = ''
        }

        function newGame() {
            wsocket.send(JSON.stringify({Cmd: "NEW"}));
            MYGAME.reset();
        }

        document.getElementById("newGame").onclick = newGame;

    </script>
</html>
